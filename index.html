import React, { useState, useEffect } from "react";

export default function PrecificacaoApp() {
  const [produtos, setProdutos] = useState([]);

  // Inputs do produto
  const [horas, setHoras] = useState(0);
  const [minutos, setMinutos] = useState(0);
  const [peso, setPeso] = useState(0);
  const [quantidade, setQuantidade] = useState(1);

  // Configura√ß√µes
  const [valorMaquina, setValorMaquina] = useState(5400);
  const [vidaUtil, setVidaUtil] = useState(24000);
  const [custoKg, setCustoKg] = useState(95);
  const [potenciaW, setPotenciaW] = useState(175);
  const [custoKwh, setCustoKwh] = useState(0.95);
  const [falhaProducao, setFalhaProducao] = useState(5);
  const [custoFixo, setCustoFixo] = useState(0.8);
  const [margemEcommerce, setMargemEcommerce] = useState(70);
  const [margemLogista, setMargemLogista] = useState(40);
  const [margemDireta, setMargemDireta] = useState(50);

  // Modal
  const [openConfig, setOpenConfig] = useState(false);
  const [openItens, setOpenItens] = useState(false);

  // Listas persistentes (acess√≥rios e embalagens)
  const [listaAcessorios, setListaAcessorios] = useState(() => {
    const saved = localStorage.getItem("acessorios");
    return saved ? JSON.parse(saved) : [];
  });
  const [listaEmbalagens, setListaEmbalagens] = useState(() => {
    const saved = localStorage.getItem("embalagens");
    return saved ? JSON.parse(saved) : [];
  });

  // Persist√™ncia no localStorage
  useEffect(() => {
    localStorage.setItem("acessorios", JSON.stringify(listaAcessorios));
  }, [listaAcessorios]);

  useEffect(() => {
    localStorage.setItem("embalagens", JSON.stringify(listaEmbalagens));
  }, [listaEmbalagens]);

  // Selecionados no produto
  const [acessoriosSelecionados, setAcessoriosSelecionados] = useState([]);
  const [embalagensSelecionadas, setEmbalagensSelecionadas] = useState([]);

  // Edi√ß√£o
  const [editId, setEditId] = useState(null);

  // Inputs para novo acess√≥rio/embalagem
  const [novoAcessorioNome, setNovoAcessorioNome] = useState("");
  const [novoAcessorioValor, setNovoAcessorioValor] = useState(0);
  const [novaEmbalagemNome, setNovaEmbalagemNome] = useState("");
  const [novaEmbalagemValor, setNovaEmbalagemValor] = useState(0);

  // Adicionar item
  const adicionarAcessorio = () => {
    if (!novoAcessorioNome || novoAcessorioValor <= 0) return;
    setListaAcessorios([...listaAcessorios, { nome: novoAcessorioNome, valor: novoAcessorioValor }]);
    setNovoAcessorioNome("");
    setNovoAcessorioValor(0);
  };

  const adicionarEmbalagem = () => {
    if (!novaEmbalagemNome || novaEmbalagemValor <= 0) return;
    setListaEmbalagens([...listaEmbalagens, { nome: novaEmbalagemNome, valor: novaEmbalagemValor }]);
    setNovaEmbalagemNome("");
    setNovaEmbalagemValor(0);
  };

  // Remover item
  const removerAcessorio = (i) => {
    setListaAcessorios(listaAcessorios.filter((_, idx) => idx !== i));
  };
  const removerEmbalagem = (i) => {
    setListaEmbalagens(listaEmbalagens.filter((_, idx) => idx !== i));
  };

  const calcularProduto = () => {
    const tempoTotalMin = horas * 60 + minutos;
    const tempoHoras = tempoTotalMin / 60;

    const custoFilamento = (peso / 1000) * custoKg;
    const potenciaKw = potenciaW / 1000;
    const custoEnergia = tempoHoras * potenciaKw * custoKwh;
    const amortizacao = (valorMaquina / vidaUtil) * tempoHoras;

    // S√≥ considera acess√≥rios/embalagens selecionados
    const custoAcessorio = acessoriosSelecionados.reduce(
      (acc, a) => acc + (a.checked ? a.valor * a.qtd : 0),
      0
    );
    const custoEmbalagem = embalagensSelecionadas.reduce(
      (acc, e) => acc + (e.checked ? e.valor * e.qtd : 0),
      0
    );

    let custoTotal = custoFilamento + custoEnergia + custoFixo + amortizacao + custoAcessorio + custoEmbalagem;

    custoTotal *= 1 + falhaProducao / 100;

    const custoUnitario = custoTotal / quantidade;
    const precoEcommerce = custoUnitario / (1 - margemEcommerce / 100);
    const precoLogista = custoUnitario / (1 - margemLogista / 100);
    const precoDireta = custoUnitario / (1 - margemDireta / 100);

    const novoProduto = {
      id: editId || produtos.length + 1,
      horas,
      minutos,
      peso,
      quantidade,
      acessoriosSelecionados,
      embalagensSelecionadas,
      custoFilamento: custoFilamento.toFixed(2),
      custoEnergia: custoEnergia.toFixed(2),
      amortizacao: amortizacao.toFixed(2),
      custoUnitario: custoUnitario.toFixed(2),
      precoEcommerce: precoEcommerce.toFixed(2),
      precoLogista: precoLogista.toFixed(2),
      precoDireta: precoDireta.toFixed(2),
    };

    if (editId) {
      setProdutos(produtos.map((p) => (p.id === editId ? novoProduto : p)));
      setEditId(null);
    } else {
      setProdutos([...produtos, novoProduto]);
    }

    // reset inputs
    setHoras(0);
    setMinutos(0);
    setPeso(0);
    setQuantidade(1);
    setAcessoriosSelecionados([]);
    setEmbalagensSelecionadas([]);
  };

  const excluirProduto = (id) => {
    setProdutos(produtos.filter((p) => p.id !== id));
  };

  return (
    <div className="p-6 font-sans bg-gray-50 min-h-screen">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-gray-800">App de Precifica√ß√£o</h1>
        <div className="space-x-2">
          <button
            className="px-4 py-2 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800"
            onClick={() => setOpenItens(true)}
          >
            üì¶ Itens
          </button>
          <button
            className="px-4 py-2 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800"
            onClick={() => setOpenConfig(true)}
          >
            ‚öôÔ∏è Configura√ß√µes
          </button>
        </div>
      </div>

      {/* Form Produto */}
      <div className="bg-white rounded-xl shadow p-6 mb-6">
        <h2 className="text-xl font-semibold mb-4">Adicionar Produto</h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <label>Horas<input className="p-2 border rounded w-full" type="number" value={horas} onChange={(e) => setHoras(+e.target.value || 0)} /></label>
          <label>Minutos<input className="p-2 border rounded w-full" type="number" value={minutos} onChange={(e) => setMinutos(+e.target.value || 0)} /></label>
          <label>Peso (g)<input className="p-2 border rounded w-full" type="number" value={peso} onChange={(e) => setPeso(+e.target.value || 0)} /></label>
          <label>Quantidade<input className="p-2 border rounded w-full" type="number" value={quantidade} onChange={(e) => setQuantidade(+e.target.value || 1)} /></label>
        </div>

        {/* Acess√≥rios */}
        <h3 className="mt-4 font-semibold">Selecionar Acess√≥rios</h3>
        {listaAcessorios.map((a, i) => (
          <label key={i} className="block">
            <input
              type="checkbox"
              onChange={(e) => {
                if (e.target.checked) {
                  setAcessoriosSelecionados([...acessoriosSelecionados, { ...a, qtd: 1, checked: true }]);
                } else {
                  setAcessoriosSelecionados(acessoriosSelecionados.filter(item => item.nome !== a.nome));
                }
              }}
            />
            {a.nome} - R$ {a.valor.toFixed(2)}
          </label>
        ))}

        {/* Embalagens */}
        <h3 className="mt-4 font-semibold">Selecionar Embalagens</h3>
        {listaEmbalagens.map((e, i) => (
          <label key={i} className="block">
            <input
              type="checkbox"
              onChange={(ev) => {
                if (ev.target.checked) {
                  setEmbalagensSelecionadas([...embalagensSelecionadas, { ...e, qtd: 1, checked: true }]);
                } else {
                  setEmbalagensSelecionadas(embalagensSelecionadas.filter(item => item.nome !== e.nome));
                }
              }}
            />
            {e.nome} - R$ {e.valor.toFixed(2)}
          </label>
        ))}

        <button
          className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700"
          onClick={calcularProduto}
        >
          Calcular e Adicionar
        </button>
      </div>

      {/* Tabela */}
      <div className="bg-white rounded-xl shadow p-6 mb-6">
        <h2 className="text-xl font-semibold mb-4">Produtos</h2>
        <div className="overflow-x-auto">
          <table className="min-w-full border border-gray-300">
            <thead className="bg-gray-100">
              <tr>
                <th className="border p-2">Horas</th>
                <th className="border p-2">Minutos</th>
                <th className="border p-2">Peso</th>
                <th className="border p-2">Qtd</th>
                <th className="border p-2">Filamento</th>
                <th className="border p-2">Energia</th>
                <th className="border p-2">Amortiza√ß√£o</th>
                <th className="border p-2">Custo Unit</th>
                <th className="border p-2">E-commerce</th>
                <th className="border p-2">Logista</th>
                <th className="border p-2">Direta</th>
                <th className="border p-2">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {produtos.map((p) => (
                <tr key={p.id}>
                  <td className="border p-2">{p.horas}</td>
                  <td className="border p-2">{p.minutos}</td>
                  <td className="border p-2">{p.peso}</td>
                  <td className="border p-2">{p.quantidade}</td>
                  <td className="border p-2">R$ {p.custoFilamento}</td>
                  <td className="border p-2">R$ {p.custoEnergia}</td>
                  <td className="border p-2">R$ {p.amortizacao}</td>
                  <td className="border p-2">R$ {p.custoUnitario}</td>
                  <td className="border p-2">R$ {p.precoEcommerce}</td>
                  <td className="border p-2">R$ {p.precoLogista}</td>
                  <td className="border p-2">R$ {p.precoDireta}</td>
                  <td className="border p-2">
                    <button
                      className="px-2 py-1 bg-red-500 text-white rounded"
                      onClick={() => excluirProduto(p.id)}
                    >
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Modal Configura√ß√µes */}
      {openConfig && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg">
            <h2 className="text-xl font-bold mb-4">‚öôÔ∏è Configura√ß√µes</h2>
            <div className="grid grid-cols-2 gap-4">
              <label>Valor da M√°quina (R$)<input className="p-2 border rounded w-full" type="number" value={valorMaquina} onChange={(e) => setValorMaquina(+e.target.value || 0)} /></label>
              <label>Vida √ötil (h)<input className="p-2 border rounded w-full" type="number" value={vidaUtil} onChange={(e) => setVidaUtil(+e.target.value || 0)} /></label>
              <label>Custo Filamento (R$/kg)<input className="p-2 border rounded w-full" type="number" value={custoKg} onChange={(e) => setCustoKg(+e.target.value || 0)} /></label>
              <label>Pot√™ncia Impressora (W)<input className="p-2 border rounded w-full" type="number" value={potenciaW} onChange={(e) => setPotenciaW(+e.target.value || 0)} /></label>
              <label>Custo kWh (R$)<input className="p-2 border rounded w-full" type="number" value={custoKwh} onChange={(e) => setCustoKwh(+e.target.value || 0)} /></label>
              <label>% Falha Produ√ß√£o<input className="p-2 border rounded w-full" type="number" value={falhaProducao} onChange={(e) => setFalhaProducao(+e.target.value || 0)} /></label>
              <label>Custo Fixo (R$)<input className="p-2 border rounded w-full" type="number" value={custoFixo} onChange={(e) => setCustoFixo(+e.target.value || 0)} /></label>
              <label>Margem E-commerce (%)<input className="p-2 border rounded w-full" type="number" value={margemEcommerce} onChange={(e) => setMargemEcommerce(+e.target.value || 0)} /></label>
              <label>Margem Lojista (%)<input className="p-2 border rounded w-full" type="number" value={margemLogista} onChange={(e) => setMargemLogista(+e.target.value || 0)} /></label>
              <label>Margem Direta (%)<input className="p-2 border rounded w-full" type="number" value={margemDireta} onChange={(e) => setMargemDireta(+e.target.value || 0)} /></label>
            </div>
            <div className="flex justify-end mt-6">
              <button className="px-4 py-2 bg-red-500 text-white rounded-lg" onClick={() => setOpenConfig(false)}>Fechar</button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Itens */}
      {openItens && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg">
            <h2 className="text-xl font-bold mb-4">üõ†Ô∏è Gerenciar Itens</h2>

            <div className="mb-4">
              <h3 className="font-semibold">Acess√≥rios</h3>
              <div className="flex gap-2 mb-2">
                <input className="p-2 border rounded w-full" placeholder="Nome" value={novoAcessorioNome} onChange={(e) => setNovoAcessorioNome(e.target.value)} />
                <input className="p-2 border rounded w-24" type="number" placeholder="Valor" value={novoAcessorioValor} onChange={(e) => setNovoAcessorioValor(+e.target.value || 0)} />
                <button className="bg-green-600 text-white px-2 rounded" onClick={adicionarAcessorio}>Adicionar</button>
              </div>
              <ul>
                {listaAcessorios.map((a, i) => (
                  <li key={i} className="flex justify-between mb-1">
                    {a.nome} - R$ {a.valor.toFixed(2)}
                    <button className="text-red-500" onClick={() => removerAcessorio(i)}>üóëÔ∏è</button>
                  </li>
                ))}
              </ul>
            </div>

            <div className="mb-4">
              <h3 className="font-semibold">Embalagens</h3>
              <div className="flex gap-2 mb-2">
                <input className="p-2 border rounded w-full" placeholder="Nome" value={novaEmbalagemNome} onChange={(e) => setNovaEmbalagemNome(e.target.value)} />
                <input className="p-2 border rounded w-24" type="number" placeholder="Valor" value={novaEmbalagemValor} onChange={(e) => setNovaEmbalagemValor(+e.target.value || 0)} />
                <button className="bg-green-600 text-white px-2 rounded" onClick={adicionarEmbalagem}>Adicionar</button>
              </div>
              <ul>
                {listaEmbalagens.map((e, i) => (
                  <li key={i} className="flex justify-between mb-1">
                    {e.nome} - R$ {e.valor.toFixed(2)}
                    <button className="text-red-500" onClick={() => removerEmbalagem(i)}>üóëÔ∏è</button>
                  </li>
                ))}
              </ul>
            </div>

            <div className="flex justify-end mt-4">
              <button className="px-4 py-2 bg-red-500 text-white rounded" onClick={() => setOpenItens(false)}>Fechar</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
